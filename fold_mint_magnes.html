<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°gnes Labor - DigiFAB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
            overflow: hidden;
            background-color: #f8fafc;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- FEJL√âC √âS L√ÅBLEC ST√çLUSOK (DigiFAB standard) --- */
        .header {
            background-color: #2563eb;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 50;
        }

        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .header h1 span { font-weight: 900; opacity: 0.8; font-size: 0.9rem; }
        
        .badge { background-color: #1d4ed8; padding: 6px 16px; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; }

        .footer {
            background-color: #0f172a;
            padding: 20px;
            color: white;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.95;
            font-family: monospace;
            z-index: 50;
        }

        /* --- LAYOUT --- */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            #main-wrapper { flex-direction: row; }
        }

        #canvas-container {
            position: relative;
            flex: 1;
            cursor: crosshair;
            background-color: #f0f9ff;
            overflow: hidden;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            width: 100%;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .panel { width: 320px; min-width: 320px; border-left: 1px solid #e2e8f0; }
        }

        .grabbing { cursor: grabbing !important; }
        .grab { cursor: grab; }
        
        /* Gomb st√≠lusok */
        .btn-mode {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-weight: 700;
            font-size: 0.85rem;
            color: #64748b;
            transition: all 0.2s;
            background-color: white;
        }
        .btn-mode:hover { border-color: #cbd5e1; }
        .btn-mode.active {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .btn-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 10px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #475569;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .btn-toggle.active { background-color: #f0f9ff; border-color: #60a5fa; color: #0369a1; }
        .btn-toggle.inactive { color: #94a3b8; }
        
        .btn-action {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.85rem;
            text-align: center;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        .btn-action-primary { border: 2px solid #cbd5e1; color: #334155; background: white; }
        .btn-action-primary:hover { border-color: #94a3b8; background-color: #f1f5f9; }
        .btn-action-danger { background-color: #fef2f2; color: #ef4444; border: 1px solid transparent; }
        .btn-action-danger:hover { background-color: #fee2e2; }

        .label-box {
            position: absolute;
            background: rgba(255, 255, 220, 0.95);
            border: 1px solid #eab308;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translate(-50%, -50%);
            white-space: nowrap;
            z-index: 10;
        }

        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.open { opacity: 1; pointer-events: auto; }

        .control-group.hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <h1><span>FIZIKA</span> üß≤ M√°gnes Labor</h1>
        </div>
        <div class="header-center font-black text-xl tracking-tighter opacity-80 hidden md:block">DigiFAB</div>
        <div class="header-right">
            <span class="badge">9. oszt√°ly</span>
        </div>
    </div>

    <div id="main-wrapper">
        <div id="canvas-container">
            <canvas id="simCanvas"></canvas>
            <div id="labels-container"></div>

            <div id="info-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 relative transform transition-transform scale-95 md:scale-100 max-h-[90vh] overflow-y-auto">
                    <button onclick="closeInfo()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold p-2">‚úï</button>
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">‚ÑπÔ∏è Hogyan m≈±k√∂dik?</h2>
                    
                    <div class="space-y-4 text-slate-600 text-sm leading-relaxed">
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <h3 class="font-bold text-blue-800 mb-1">üß≤ A M√°gnes</h3>
                            <p>Minden m√°gnesnek k√©t p√≥lusa van: <strong>√âszaki (N)</strong> √©s <strong>D√©li (S)</strong>. Az er≈ëvonalak az √âszaki p√≥lusb√≥l indulnak ki.</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <h3 class="font-bold text-green-800 mb-1">üåç A F√∂ld mint m√°gnes</h3>
                            <p>A F√∂ld m√°gneses tere v√©di az √©l≈ël√©nyeket. √ârdekess√©g: A f√∂ldrajzi √âszaki-sarkn√°l a m√°gneses <em>D√©li</em> p√≥lus tal√°lhat√≥.</p>
                        </div>
                    </div>
                    
                    <button onclick="closeInfo()" class="mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">√ârtem!</button>
                </div>
            </div>
        </div>

        <div class="panel p-6 flex flex-col">
            <div class="mb-6 flex justify-between items-center">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Be√°ll√≠t√°sok</h3>
                <button class="w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-600 rounded-full text-sm font-bold" onclick="openInfo()">‚ÑπÔ∏è</button>
            </div>

            <div class="flex gap-2 mb-6">
                <button id="mode-magnet" class="btn-mode active" onclick="setMode('magnet')">üß≤ R√∫dm√°gnes</button>
                <button id="mode-earth" class="btn-mode" onclick="setMode('earth')">üåç F√∂ld</button>
            </div>

            <div id="controls-magnet" class="control-group mb-6">
                <button id="btn-view-mode" class="btn-toggle active" onclick="toggleViewMode()">
                    <span>üëÅÔ∏è N√©zet</span>
                    <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded">Er≈ëvonalak</span>
                </button>
                <button id="btn-labels" class="btn-toggle" onclick="toggleLabels()">
                    <span>üè∑Ô∏è Feliratok</span>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">KI</span>
                </button>
                <button class="btn-action btn-action-primary mt-2" onclick="flipMagnet()">üîÑ Polarit√°s v√°lt√°sa</button>
            </div>

            <div id="controls-earth" class="control-group mb-6 hidden">
                <button id="btn-earth-lines" class="btn-toggle inactive" onclick="toggleEarthLines()">
                    <span>„Ä∞Ô∏è Er≈ëvonalak</span>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">KI</span>
                </button>
                <button id="btn-geo" class="btn-toggle inactive" onclick="toggleEarthFeat('geo')">
                    <span>üìç F√∂ldrajzi tengely</span>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">KI</span>
                </button>
                <button id="btn-mag" class="btn-toggle inactive" onclick="toggleEarthFeat('mag')">
                    <span>‚ö° M√°gneses tengely</span>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">KI</span>
                </button>
            </div>

            <div class="mt-auto border-t pt-4">
                <button id="btn-compass" class="btn-toggle inactive mb-3" onclick="toggleCompass()">
                    <span>üß≠ Ir√°nyt≈± (T≈±m√°gnes)</span>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">KI</span>
                </button>
                <button class="btn-action btn-action-danger" onclick="resetSim()">‚Ü©Ô∏è Alaphelyzet</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <span>Digit√°lis FABrik√°l√≥ M≈±hely</span>
        <span class="text-blue-500 font-black">.:henz:.</span>
        <span>Henzel Gy√∂rgy</span>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const labelsContainer = document.getElementById('labels-container');

        const CFG = {
            magnetW: 240,
            magnetH: 70,
            compassR: 45,
            earthTilt: 11.5 * (Math.PI / 180), 
        };

        let state = {
            w: 0, h: 0,
            scene: 'magnet',
            view: 'lines',
            showLabels: false,
            showCompass: false, 
            showGeo: false,
            showMag: false,
            isFlipped: false,
            magnet: { x: 0, y: 0, dragging: false, dragOffX: 0, dragOffY: 0 },
            compass: { x: 0, y: 0, dragging: false, dragOffX: 0, dragOffY: 0, angle: 0 }
        };

        function init() {
            window.addEventListener('resize', resize);
            resize();
            canvas.addEventListener('mousedown', onPointerDown);
            canvas.addEventListener('mousemove', onPointerMove);
            window.addEventListener('mouseup', onPointerUp);
            canvas.addEventListener('touchstart', (e) => onPointerDown(e.touches[0]));
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); onPointerMove(e.touches[0]); }, {passive: false});
            window.addEventListener('touchend', onPointerUp);
            updateUI();
            requestAnimationFrame(loop);
        }

        function resize() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            state.w = canvas.width;
            state.h = canvas.height;
            if (state.magnet.x === 0) resetSim();
        }

        function resetSim() {
            state.magnet.x = state.w / 2;
            state.magnet.y = state.h / 2;
            state.compass.x = state.w / 2;
            state.compass.y = state.h / 2 - 180;
            state.isFlipped = false;
            state.showCompass = false;
            if (state.scene === 'earth') {
                state.view = null;
                state.showGeo = false;
                state.showMag = false;
            } else {
                state.view = 'lines';
                state.showLabels = false;
            }
            updateUI(); 
        }

        function setMode(mode) {
            state.scene = mode;
            if (mode === 'earth') {
                state.view = null; 
                state.showLabels = false;
                state.showGeo = false;
                state.showMag = false;
            } else {
                state.view = 'lines';
            }
            updateUI();
        }

        function toggleViewMode() {
            state.view = (state.view === 'lines') ? 'grid' : 'lines';
            updateUI();
        }

        function toggleEarthLines() {
            state.view = (state.view === 'lines') ? null : 'lines';
            updateUI();
        }

        function toggleLabels() { state.showLabels = !state.showLabels; updateUI(); }
        function toggleCompass() { state.showCompass = !state.showCompass; updateUI(); }
        function toggleEarthFeat(feat) {
            if (feat === 'geo') state.showGeo = !state.showGeo;
            if (feat === 'mag') state.showMag = !state.showMag;
            updateUI();
        }

        function updateUI() {
            const btnMag = document.getElementById('mode-magnet');
            const btnEar = document.getElementById('mode-earth');
            const ctrlMag = document.getElementById('controls-magnet');
            const ctrlEar = document.getElementById('controls-earth');

            if (state.scene === 'magnet') {
                btnMag.classList.add('active');
                btnEar.classList.remove('active');
                ctrlMag.classList.remove('hidden');
                ctrlEar.classList.add('hidden');
            } else {
                btnMag.classList.remove('active');
                btnEar.classList.add('active');
                ctrlMag.classList.add('hidden');
                ctrlEar.classList.remove('hidden');
            }

            const btnView = document.getElementById('btn-view-mode');
            if (btnView) {
                const badge = btnView.querySelector('span:last-child');
                badge.innerText = (state.view === 'lines') ? "Er≈ëvonalak" : "T≈±m√°gnesek";
            }

            setBtnState('btn-earth-lines', state.view === 'lines');
            setBtnState('btn-labels', state.showLabels);
            setBtnState('btn-compass', state.showCompass);
            setBtnState('btn-geo', state.showGeo);
            setBtnState('btn-mag', state.showMag);
        }

        function setBtnState(id, isActive) {
            const btn = document.getElementById(id);
            if (!btn) return;
            const badge = btn.querySelector('span:last-child');
            if (isActive) {
                btn.classList.add('active'); btn.classList.remove('inactive');
                badge.innerText = "BE";
            } else {
                btn.classList.remove('active'); btn.classList.add('inactive');
                badge.innerText = "KI";
            }
        }

        function flipMagnet() { state.isFlipped = !state.isFlipped; }

        function getBField(px, py) {
            let Bx = 0, By = 0;
            if (state.scene === 'earth') {
                const cx = state.w / 2, cy = state.h / 2;
                const earthR = Math.min(state.w, state.h) * 0.30;
                const poleDist = (earthR * 1.05) * 0.95;
                const sin = Math.sin(-CFG.earthTilt), cos = Math.cos(-CFG.earthTilt);
                const nx = cx - poleDist * sin, ny = cy + poleDist * cos;
                const sx = cx + poleDist * sin, sy = cy - poleDist * cos;
                const rN = Math.hypot(px - nx, py - ny), rS = Math.hypot(px - sx, py - sy);
                const K = 5000000;
                Bx += K * (px - nx) / Math.pow(Math.max(rN, 30), 3);
                By += K * (py - ny) / Math.pow(Math.max(rN, 30), 3);
                Bx -= K * (px - sx) / Math.pow(Math.max(rS, 30), 3);
                By -= K * (py - sy) / Math.pow(Math.max(rS, 30), 3);
            } else {
                const mx = state.magnet.x, my = state.magnet.y;
                const halfLen = (CFG.magnetW / 2) * 0.85;
                let nx, ny, sx, sy;
                if (!state.isFlipped) { nx = mx + halfLen; ny = my; sx = mx - halfLen; sy = my; } 
                else { nx = mx - halfLen; ny = my; sx = mx + halfLen; sy = my; }
                const rN = Math.hypot(px - nx, py - ny), rS = Math.hypot(px - sx, py - sy);
                const K = 6000;
                Bx += K * (px - nx) / Math.pow(Math.max(rN, 20), 3);
                By += K * (py - ny) / Math.pow(Math.max(rN, 20), 3);
                Bx -= K * (px - sx) / Math.pow(Math.max(rS, 20), 3);
                By -= K * (py - sy) / Math.pow(Math.max(rS, 20), 3);
            }
            return { x: Bx, y: By, mag: Math.hypot(Bx, By) };
        }

        function loop() {
            ctx.clearRect(0, 0, state.w, state.h);
            if (state.view === 'grid') drawFieldGrid();
            else if (state.view === 'lines') drawSymmetricLines();
            if (state.scene === 'earth') drawEarthObj();
            else drawMagnetObj();
            if (state.showCompass) drawCompassObj();
            updateLabels();
            requestAnimationFrame(loop);
        }

        function drawSymmetricLines() {
            ctx.save();
            ctx.strokeStyle = "rgba(100, 116, 139, 0.4)";
            ctx.lineWidth = 1.2;
            const step = 80; 
            for (let x = 0; x < state.w; x += step) {
                for (let y = 0; y < state.h; y += step) {
                    if (checkCollision(x, y)) continue;
                    traceBidirectional(x, y);
                }
            }
            ctx.restore();
        }

        function traceBidirectional(sx, sy) {
            ctx.beginPath();
            let cx = sx, cy = sy;
            ctx.moveTo(cx, cy);
            for (let i = 0; i < 20; i++) { 
                const f = getBField(cx, cy);
                if (f.mag < 0.0001) break;
                const dx = (f.x / f.mag) * 8, dy = (f.y / f.mag) * 8;
                cx += dx; cy += dy;
                ctx.lineTo(cx, cy);
                if (cx < -20 || cx > state.w+20 || cy < -20 || cy > state.h+20 || checkCollision(cx, cy)) break;
            }
            ctx.stroke();

            ctx.beginPath();
            cx = sx; cy = sy; ctx.moveTo(cx, cy);
            for (let i = 0; i < 20; i++) {
                const f = getBField(cx, cy);
                if (f.mag < 0.0001) break;
                const dx = (f.x / f.mag) * 8, dy = (f.y / f.mag) * 8;
                cx -= dx; cy -= dy; ctx.lineTo(cx, cy);
                if (cx < -20 || cx > state.w+20 || cy < -20 || cy > state.h+20 || checkCollision(cx, cy)) break;
            }
            ctx.stroke();
            if (Math.random() > 0.6) drawArrowHead(sx, sy, getBField(sx, sy));
        }

        function checkCollision(x, y) {
            if (state.scene === 'earth') {
                const cx = state.w/2, cy = state.h/2, r = Math.min(state.w, state.h) * 0.30;
                return Math.hypot(x-cx, y-cy) < r;
            } else {
                const mx = state.magnet.x, my = state.magnet.y;
                return Math.abs(x - mx) < CFG.magnetW/2 && Math.abs(y - my) < CFG.magnetH/2;
            }
        }

        function drawFieldGrid() {
            ctx.save();
            const step = 50;
            for (let x = step/2; x < state.w; x += step) {
                for (let y = step/2; y < state.h; y += step) {
                    if (checkCollision(x, y)) continue;
                    const f = getBField(x, y);
                    const angle = Math.atan2(f.y, f.x);
                    const opacity = Math.min(1, f.mag * 100 + 0.2);
                    ctx.fillStyle = `rgba(100, 116, 139, ${opacity})`;
                    ctx.translate(x, y); ctx.rotate(angle); ctx.beginPath();
                    ctx.moveTo(-7, -2.5); ctx.lineTo(7, 0); ctx.lineTo(-7, 2.5); ctx.fill();
                    ctx.rotate(-angle); ctx.translate(-x, -y);
                }
            }
            ctx.restore();
        }

        function drawArrowHead(x, y, field) {
            const angle = Math.atan2(field.y, field.x);
            ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
            ctx.fillStyle = "rgba(71, 85, 105, 0.7)";
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-5, -2.5); ctx.lineTo(-5, 2.5); ctx.fill();
            ctx.restore();
        }

        function drawEarthObj() {
            const cx = state.w / 2, cy = state.h / 2, size = Math.min(state.w, state.h) * 0.30, dr = size * 1.05;
            ctx.save();
            ctx.globalAlpha = 0.3; ctx.font = `${size * 2}px serif`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("üåç", cx, cy + size*0.1); ctx.globalAlpha = 1.0;
            ctx.beginPath(); ctx.arc(cx, cy, dr, 0, Math.PI*2); ctx.strokeStyle = "rgba(37, 99, 235, 0.3)"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.stroke();
            ctx.setLineDash([]); ctx.translate(cx, cy); ctx.rotate(-CFG.earthTilt);
            if (state.showGeo) {
                ctx.save(); ctx.rotate(CFG.earthTilt); ctx.strokeStyle = "#2563eb"; ctx.lineWidth = 2; ctx.setLineDash([8, 4]);
                ctx.beginPath(); ctx.moveTo(0, -dr * 1.3); ctx.lineTo(0, dr * 1.3); ctx.stroke();
                ctx.fillStyle = "#2563eb"; ctx.beginPath(); ctx.arc(0, -dr, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(0, dr, 5, 0, Math.PI*2); ctx.fill();
                ctx.font = "bold 11px Arial"; ctx.textAlign = "center";
                ctx.fillText("F√∂ldrajzi √©szaki", 0, -dr - 15); ctx.fillText("F√∂ldrajzi d√©li", 0, dr + 20);
                ctx.restore();
            }
            if (state.showMag) {
                ctx.strokeStyle = "#dc2626"; ctx.lineWidth = 2; ctx.setLineDash([8, 4]);
                ctx.beginPath(); ctx.moveTo(0, -dr * 1.3); ctx.lineTo(0, dr * 1.3); ctx.stroke();
                ctx.fillStyle = "#dc2626"; ctx.beginPath(); ctx.arc(0, -dr, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(0, dr, 5, 0, Math.PI*2); ctx.fill();
                ctx.save(); ctx.translate(0, -dr); ctx.rotate(CFG.earthTilt); ctx.font = "bold 11px Arial"; ctx.fillText("M√°gneses d√©li", 0, 22); ctx.restore();
            }
            ctx.restore();
        }

        function drawMagnetObj() {
            const { x, y } = state.magnet, w = CFG.magnetW, h = CFG.magnetH;
            ctx.save(); ctx.translate(x, y); ctx.shadowColor = "rgba(0,0,0,0.15)"; ctx.shadowBlur = 10;
            ctx.fillStyle = state.isFlipped ? "#ef4444" : "#f1f5f9"; ctx.fillRect(-w/2, -h/2, w/2, h);
            ctx.fillStyle = state.isFlipped ? "#f1f5f9" : "#ef4444"; ctx.fillRect(0, -h/2, w/2, h);
            ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 1.5; ctx.strokeRect(-w/2, -h/2, w, h);
            ctx.fillStyle = state.isFlipped ? "white" : "#1e293b"; ctx.font = "bold 24px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(state.isFlipped ? "N" : "S", -w/4, 0); ctx.fillStyle = state.isFlipped ? "#1e293b" : "white";
            ctx.fillText(state.isFlipped ? "S" : "N", w/4, 0); ctx.restore();
        }

        function drawCompassObj() {
            const { x, y } = state.compass, r = CFG.compassR, f = getBField(x, y);
            const targetAngle = Math.atan2(f.y, f.x);
            let diff = targetAngle - state.compass.angle;
            while (diff > Math.PI) diff -= Math.PI*2; while (diff < -Math.PI) diff += Math.PI*2;
            state.compass.angle += diff * 0.15;
            ctx.save(); ctx.translate(x, y); ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fillStyle = "white"; ctx.fill();
            ctx.strokeStyle = "#475569"; ctx.lineWidth = 2.5; ctx.stroke(); ctx.rotate(state.compass.angle);
            ctx.beginPath(); ctx.moveTo(0, -5); ctx.lineTo(r-6, 0); ctx.lineTo(0, 5); ctx.fillStyle = "#dc2626"; ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, -5); ctx.lineTo(-(r-6), 0); ctx.lineTo(0, 5); ctx.fillStyle = "#cbd5e1"; ctx.fill();
            ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fillStyle = "#1e293b"; ctx.fill(); ctx.restore();
        }

        function updateLabels() {
            labelsContainer.innerHTML = '';
            if (!state.showLabels || state.scene === 'earth') return;
            const { x, y } = state.magnet, w = CFG.magnetW;
            const addL = (t, tx, ty, lx, ly) => {
                const b = document.createElement('div'); b.className = 'label-box'; b.innerText = t;
                b.style.left = lx + 'px'; b.style.top = ly + 'px'; labelsContainer.appendChild(b);
            };
            if (state.isFlipped) { addL("P√≥lus (N)", x - w/3, y, x - w/2 - 20, y - 50); addL("P√≥lus (S)", x + w/3, y, x + w/2 + 20, y + 50); }
            else { addL("P√≥lus (S)", x - w/3, y, x - w/2 - 20, y - 50); addL("P√≥lus (N)", x + w/3, y, x + w/2 + 20, y + 50); }
        }

        function onPointerDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left, y = (e.clientY || e.pageY) - rect.top;
            if (state.showCompass && Math.hypot(x - state.compass.x, y - state.compass.y) < CFG.compassR) {
                state.compass.dragging = true; state.compass.dragOffX = x - state.compass.x; state.compass.dragOffY = y - state.compass.y; return;
            }
            if (state.scene === 'magnet' && Math.abs(x - state.magnet.x) < CFG.magnetW/2 && Math.abs(y - state.magnet.y) < CFG.magnetH/2) {
                state.magnet.dragging = true; state.magnet.dragOffX = x - state.magnet.x; state.magnet.dragOffY = y - state.magnet.y; canvas.classList.add('grabbing');
            }
        }

        function onPointerMove(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left, y = (e.clientY || e.pageY) - rect.top;
            if (state.compass.dragging) { state.compass.x = x - state.compass.dragOffX; state.compass.y = y - state.compass.dragOffY; } 
            else if (state.magnet.dragging) { state.magnet.x = x - state.magnet.dragOffX; state.magnet.y = y - state.magnet.dragOffY; }
        }
        function onPointerUp() { state.magnet.dragging = false; state.compass.dragging = false; canvas.classList.remove('grabbing'); }
        function openInfo() { document.getElementById('info-modal').classList.add('open'); }
        function closeInfo() { document.getElementById('info-modal').classList.remove('open'); }

        window.onload = init;
    </script>
</body>
<button onclick="location.href='index.html'" style="
    position: fixed; 
    top: 10px; 
    right: 140px; 
    padding: 10px 10px; 
    background: #FFF3eb; 
    color: green; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(2,2,2,0.2);
">üè†</button>
</html>